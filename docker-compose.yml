services:
  immobilien-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: immobilien-app
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      - NODE_ENV=production
      - VITE_USE_REMOTE_OVM_STORAGE=${USE_REMOTE_STORAGE:-false}
      - VITE_API_BASE_URL=${API_BASE_URL:-}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "app=immobilien"
      - "environment=production"
    networks:
      - immobilien-network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  upload-server:
    image: ghcr.io/robindmn/immobilien-upload-server:latest
    container_name: immobilien-upload-server
    restart: unless-stopped
    
    ports:
      - "127.0.0.1:3001:3001"
    
    environment:
      - NODE_ENV=production
      - PORT=3001
    
    volumes:
      - upload-data:/app/uploads
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "app=immobilien-upload"
      - "environment=production"
    
    networks:
      - immobilien-network
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  upload-data:
    driver: local

networks:
  immobilien-network:
    driver: bridge

# Optional: Watchtower f√ºr automatische Updates
# Uncomment if you want auto-updates on image changes
#  watchtower:
#    image: containrrr/watchtower
#    container_name: watchtower
#    restart: unless-stopped
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock
#    environment:
#      - WATCHTOWER_CLEANUP=true
#      - WATCHTOWER_POLL_INTERVAL=300
#      - WATCHTOWER_LABEL_ENABLE=true
#    networks:
#      - immobilien-network
