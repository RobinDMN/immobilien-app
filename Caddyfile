# =============================================================================
# Caddyfile für Immobilien-App Reverse Proxy
# =============================================================================
# 
# Installation auf Hetzner Server:
#   sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
#   curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
#   curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
#   sudo apt update
#   sudo apt install caddy
#
# Deployment:
#   sudo cp Caddyfile /etc/caddy/Caddyfile
#   sudo systemctl reload caddy

# Production
your-domain.com {
    # Automatisches HTTPS mit Let's Encrypt
    encode gzip zstd
    
    # Security Headers
    header {
        # Enable HSTS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"
        
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # Enable XSS protection
        X-XSS-Protection "1; mode=block"
        
        # Referrer Policy
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Content Security Policy (anpassen nach Bedarf)
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'"
        
        # Permissions Policy
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        
        # Remove Server header
        -Server
    }
    
    # Reverse Proxy zu Docker Container
    reverse_proxy localhost:3000 {
        # Health check
        health_uri /health
        health_interval 30s
        health_timeout 5s
        health_status 2xx
        
        # Load balancing (bei mehreren Instanzen)
        lb_policy round_robin
    }
    
    # Logging
    log {
        output file /var/log/caddy/immobilien-app.log
        format json
        level INFO
    }
}

# Staging (optional)
staging.your-domain.com {
    encode gzip zstd
    
    # Basic Auth für Staging
    basicauth {
        staging $2a$14$Zkx19XLiW6VYouLHR5NmfOFU0z2GTNmpkT/5qqR9wwfH8DxGBZrYO
    }
    
    reverse_proxy localhost:3001 {
        health_uri /health
        health_interval 30s
    }
    
    log {
        output file /var/log/caddy/immobilien-app-staging.log
    }
}

# HTTP to HTTPS redirect
http://your-domain.com {
    redir https://your-domain.com{uri} permanent
}

http://staging.your-domain.com {
    redir https://staging.your-domain.com{uri} permanent
}
